<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 MQTT 제어 시스템</title>
    <!-- MQTT 웹소켓 클라이언트 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- 차트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .device-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .device-selector label {
            font-weight: bold;
            color: #3498db;
        }
        .device-selector select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 1em;
            min-width: 200px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-top: 0;
            color: #3498db;
            font-size: 1.2em;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        input[type="range"], input[type="text"] {
            width: 100%;
            margin: 10px 0;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
        .value-display {
            font-size: 3em;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }
        .touch-values {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 8px;
            margin: 10px 0;
            font-size: 1.2em;
            text-align: center;
        }
        .rgb-controls {
            margin: 10px 0;
        }
        .rgb-controls > div {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .rgb-controls label {
            width: 30px;
            font-weight: bold;
        }
        .rgb-controls input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }
        .rgb-preview {
            height: 30px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ccc;
            background-color: #000;
        }
        .preset-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .buzzer-controls > div {
            margin: 8px 0;
        }
        .buzzer-controls label {
            display: block;
            margin-bottom: 3px;
        }
        .preset-notes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .note-btn {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .lcd-separator {
            text-align: center;
            margin: 10px 0;
            color: #888;
            font-style: italic;
        }
        .lcd-two-lines {
            margin-top: 10px;
        }
        .lcd-two-lines input {
            margin-bottom: 5px;
            width: 100%;
        }
        .lcd-preview {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }
        .lcd-screen {
            background: #9ab9cc;
            color: #000033;
            border: 2px solid #666;
            border-radius: 4px;
            padding: 10px;
            width: 100%;
            max-width: 240px;
            font-family: monospace;
        }
        .lcd-line {
            height: 20px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            font-size: 14px;
            letter-spacing: 1px;
        }
        .status {
            padding: 10px;
            margin-top: 20px;
            background: #eee;
            border-radius: 5px;
        }
        .device-info-panel {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .device-info-panel h2 {
            margin-top: 0;
            font-size: 1.3em;
            color: #3498db;
        }
        .no-devices {
            color: #6c757d;
            font-style: italic;
            padding: 10px 0;
        }
        .selected-device-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ced4da;
        }
        .selected-device-info p {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .selected-device-info strong {
            color: #495057;
            min-width: 80px;
            display: inline-block;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            color: white;
            margin-left: 5px;
        }
        .status-badge.online { background-color: #28a745; }
        .status-badge.offline { background-color: #dc3545; }

        .status { /* 연결 상태 메시지 스타일 */
            padding: 10px;
            margin-bottom: 20px; /* .dashboard와의 간격 */
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }
        .status.connecting { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status.connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: bold; }
        
        .touch-counts-container {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            font-size: 1.1em;
        }
        .touch-counts-container > div {
            text-align: center;
        }
        .touch-counts-container span {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.5em;
            display: block; /* 숫자를 레이블 아래로 */
        }

        .chart-container { /* 차트 컨테이너 높이 */
            height: 350px; /* 필요에 따라 조절 */
            margin-bottom: 20px;
        }
        
        /* LCD 미리보기 화면 개선 */
        .lcd-preview {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        .lcd-screen {
            background-color: #2a3b4d; /* 어두운 LCD 배경 */
            color: #76ff03; /* 밝은 녹색 텍스트 (형광 느낌) */
            border: 3px solid #546e7a; /* 두꺼운 테두리 */
            border-radius: 5px;
            padding: 8px;
            width: 100%;
            max-width: 280px; /* 약간 넓게 */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* 고정폭 폰트 */
            box-shadow: inset 0 0 8px rgba(0,0,0,0.4); /* 내부 그림자 */
        }
        .lcd-line {
            height: 22px; /* 줄 높이 */
            line-height: 22px;
            white-space: pre; /* 공백, 줄바꿈 문자 그대로 표시 */
            overflow: hidden;
            font-size: 15px; /* 폰트 크기 */
            letter-spacing: 1.2px; /* 자간 */
        }
        #lcd-line1-input, #lcd-line2-input { /* LCD 입력 필드 개선 */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 5px;
            box-sizing: border-box; /* 패딩 포함한 너비 계산 */
        }
        #lcd-text { /* 단일 입력 LCD 필드 */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        /* 피아노 건반 스타일 */
        .piano-keys {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #333;
            border-radius: 5px;
        }
        .piano-key {
            padding: 20px 10px;
            margin: 0 2px;
            border: 1px solid #000;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.1s;
            flex-grow: 1; /* 버튼이 공간을 채우도록 */
            text-align: center;
        }
        .piano-key.white-key {
            background-color: #fff;
            color: #000;
            min-width: 40px; /* 최소 너비 */
        }
        .piano-key.white-key:hover {
            background-color: #eee;
        }
        .piano-key.white-key:active {
            background-color: #ddd;
        }
        #buzzer-stop-btn { /* 부저 중지 버튼 */
            display: block;
            width: 50%;
            margin: 10px auto 0;
            background-color: #e74c3c; /* 빨간색 계열 */
        }
        #buzzer-stop-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 MQTT 제어 시스템</h1>

        <!-- 기기 정보 패널 -->
        <div class="device-info-panel">
            <h2>기기 정보 <span id="devices-count">0</span>개 기기 발견</h2>
            <div id="no-devices-message" class="no-devices">
                아직 발견된 ESP32 기기가 없습니다. 기기를 연결하고 재시작하세요.
            </div>
            <div class="device-selector">
                <label for="device-select">기기 선택:</label>
                <select id="device-select" onchange="selectDevice(this.value)">
                    <option value="">기기를 선택하세요</option>
                </select>
            </div>
            <div class="selected-device-info" id="device-details" style="display:none;">
                <p><strong>ID:</strong> <span id="current-device-id">-</span></p>
                <p><strong>센서 토픽:</strong> <span id="current-topic-sensor">-</span></p>
                <p><strong>제어 토픽:</strong> <span id="current-topic-control">-</span></p>
                <p><strong>IP:</strong> <span id="current-device-ip">-</span></p>
                <p><strong>상태:</strong> <span id="current-device-status" class="status-badge offline">오프라인</span></p>
            </div>
        </div>

        <div class="status" id="connection-status">
            연결 상태: 연결 중...
        </div>

        <div class="dashboard">
            <!-- 센서 데이터 표시 -->
            <div class="card">
                <h2>온도</h2>
                <div class="value-display" id="temperature">--°C</div>
            </div>
            <div class="card">
                <h2>습도</h2>
                <div class="value-display" id="humidity">--%</div>
            </div>
            <div class="card">
                <h2>터치 센서 (누적)</h2>
                <div class="touch-counts-container">
                    <div>터치 1: <span id="touch_count1">0</span></div>
                    <div>터치 2: <span id="touch_count2">0</span></div>
                    <div>터치 3: <span id="touch_count3">0</span></div>
                    <div>터치 4: <span id="touch_count4">0</span></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="sensorChart"></canvas>
        </div>

        <div class="controls" id="device-controls" style="display:none;">
            <div class="card">
                <h2>서보 모터 제어</h2>
                <input type="range" id="servo-control" min="0" max="180" value="90">
                <div id="servo-value">90°</div>
                <button id="servo-send">서보 위치 설정</button>
            </div>

            <div class="card">
                <h2>RGB LED 제어</h2>
                <div class="rgb-controls">
                    <div>
                        <label for="rgb-red">R:</label>
                        <input type="range" id="rgb-red" min="0" max="255" value="0">
                        <span id="rgb-red-value">0</span>
                    </div>
                    <div>
                        <label for="rgb-green">G:</label>
                        <input type="range" id="rgb-green" min="0" max="255" value="0">
                        <span id="rgb-green-value">0</span>
                    </div>
                    <div>
                        <label for="rgb-blue">B:</label>
                        <input type="range" id="rgb-blue" min="0" max="255" value="0">
                        <span id="rgb-blue-value">0</span>
                    </div>
                    <div class="rgb-preview" id="rgb-preview">&nbsp;</div>
                </div>
                <button id="rgb-send">RGB LED 색상 설정</button>
                <div class="preset-colors">
                    <button class="color-btn" data-color="[255,0,0]" style="background-color: red;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,255,0]" style="background-color: green;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,0,255]" style="background-color: blue;">&nbsp;</button>
                    <button class="color-btn" data-color="[255,0,255]" style="background-color: magenta;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,255,255]" style="background-color: cyan;">&nbsp;</button>
                    <button class="color-btn" data-color="[255,255,255]" style="background-color: white; border: 1px solid #ccc;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,0,0]" style="background-color: black;">&nbsp;</button>
                </div>
            </div>

            <div class="card">
                <h2>LCD 제어</h2>
                <div class="lcd-single-line">
                    <input type="text" id="lcd-text" placeholder="LCD에 표시할 텍스트 입력 (자동 줄바꿈)">
                    <button id="lcd-send">LCD에 표시</button>
                </div>
                <div class="lcd-separator">- 또는 -</div>
                <div class="lcd-two-lines">
                    <input type="text" id="lcd-line1-input" placeholder="첫 번째 줄 텍스트 (최대 16자)">
                    <input type="text" id="lcd-line2-input" placeholder="두 번째 줄 텍스트 (최대 16자)">
                    <button id="lcd-two-lines-send">두 줄 표시</button>
                </div>
                <div class="lcd-preview">
                    <div class="lcd-screen">
                        <div class="lcd-line" id="lcd-preview-line1">LCD 메시지</div>
                        <div class="lcd-line" id="lcd-preview-line2"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>부저 연주</h2>
                <div class="piano-keys">
                    <button class="piano-key white-key" data-note="C4" data-freq="262">도</button>
                    <button class="piano-key white-key" data-note="D4" data-freq="294">레</button>
                    <button class="piano-key white-key" data-note="E4" data-freq="330">미</button>
                    <button class="piano-key white-key" data-note="F4" data-freq="349">파</button>
                    <button class="piano-key white-key" data-note="G4" data-freq="392">솔</button>
                    <button class="piano-key white-key" data-note="A4" data-freq="440">라</button>
                    <button class="piano-key white-key" data-note="B4" data-freq="494">시</button>
                    <button class="piano-key white-key" data-note="C5" data-freq="523">도</button>
                </div>
                <button id="buzzer-stop-btn">부저 중지</button>
            </div>
        </div>
                <h2>서보 모터 제어</h2>
                <input type="range" id="servo-control" min="0" max="180" value="90">
                <div id="servo-value">90°</div>
                <button id="servo-send">서보 위치 설정</button>
            </div>
            
            <div class="card">
                <h2>RGB LED 제어</h2>
                <div class="rgb-controls">
                    <div>
                        <label for="rgb-red">R:</label>
                        <input type="range" id="rgb-red" min="0" max="255" value="0">
                        <span id="rgb-red-value">0</span>
                    </div>
                    <div>
                        <label for="rgb-green">G:</label>
                        <input type="range" id="rgb-green" min="0" max="255" value="0">
                        <span id="rgb-green-value">0</span>
                    </div>
                    <div>
                        <label for="rgb-blue">B:</label>
                        <input type="range" id="rgb-blue" min="0" max="255" value="0">
                        <span id="rgb-blue-value">0</span>
                    </div>
                    <div class="rgb-preview" id="rgb-preview">&nbsp;</div>
                </div>
                <button id="rgb-send">RGB LED 색상 설정</button>
                <div class="preset-colors">
                    <button class="color-btn" data-color="[255,0,0]" style="background-color: red;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,255,0]" style="background-color: green;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,0,255]" style="background-color: blue;">&nbsp;</button>
                    <button class="color-btn" data-color="[255,255,0]" style="background-color: yellow;">&nbsp;</button>
                    <button class="color-btn" data-color="[255,0,255]" style="background-color: magenta;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,255,255]" style="background-color: cyan;">&nbsp;</button>
                    <button class="color-btn" data-color="[255,255,255]" style="background-color: white;">&nbsp;</button>
                    <button class="color-btn" data-color="[0,0,0]" style="background-color: black;">&nbsp;</button>
                </div>
            </div>
            
            <div class="card">
                <h2>부저 제어</h2>
                <div class="buzzer-controls">
                    <div>
                        <label for="buzzer-freq">주파수 (Hz):</label>
                        <input type="number" id="buzzer-freq" min="0" max="20000" value="440" step="10">
                    </div>
                    <div>
                        <label for="buzzer-duration">지속시간 (ms):</label>
                        <input type="number" id="buzzer-duration" min="0" max="5000" value="300" step="50">
                    </div>
                </div>
                <button id="buzzer-send">부저 음 재생</button>
                <button id="buzzer-stop">부저 중지</button>
                <div class="preset-notes">
                    <button class="note-btn" data-freq="262">C4</button>
                    <button class="note-btn" data-freq="294">D4</button>
                    <button class="note-btn" data-freq="330">E4</button>
                    <button class="note-btn" data-freq="349">F4</button>
                    <button class="note-btn" data-freq="392">G4</button>
                    <button class="note-btn" data-freq="440">A4</button>
                    <button class="note-btn" data-freq="494">B4</button>
                </div>
            </div>
            
            <div class="card">
                <h2>LCD 제어</h2>
                <div class="lcd-single-line">
                    <input type="text" id="lcd-text" placeholder="LCD에 표시할 텍스트 입력 (자동 줄바꿈)">
                    <button id="lcd-send">LCD에 표시</button>
                </div>
                <div class="lcd-separator">- 또는 -</div>
                <div class="lcd-two-lines">
                    <input type="text" id="lcd-line1" placeholder="첫 번째 줄 텍스트">
                    <input type="text" id="lcd-line2" placeholder="두 번째 줄 텍스트">
                    <button id="lcd-two-lines-send">두 줄 표시</button>
                </div>
                <div class="lcd-preview">
                    <div class="lcd-screen">
                        <div class="lcd-line" id="lcd-line1">LCD 메시지</div>
                        <div class="lcd-line" id="lcd-line2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT 설정
        // 옵션 1: 로컬 Mosquitto 브로커 (로컬 네트워크 내에서만 작동)
        // const MQTT_BROKER = "192.168.0.x"; // 로컬 컴퓨터 IP 주소로 변경
        // const MQTT_PORT = 9001; // Mosquitto 웹소켓 포트
        
        // 옵션 2: 공개 HiveMQ 브로커 (인터넷 연결 필요, 초보자에게 권장)
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8000; // HiveMQ 웹소켓 포트
        
        // 고유 클라이언트 ID 생성
        const MQTT_CLIENT_ID = "web_client_" + Math.random().toString(16).substr(2, 8);
        
        // MQTT 토픽 상수 정의
        const MQTT_TOPIC_SENSOR = "myhome/livingroom/+/status"; // +는 모든 기기
        const MQTT_TOPIC_CONTROL = "myhome/livingroom/+/command"; // +는 모든 기기
        const MQTT_TOPIC_LCD = "myhome/livingroom/+/lcd"; // +는 모든 기기
        
        // 현재 선택된 기기 ID
        let currentDevice = "";
        
        // 기기 목록을 저장할 객체
        let devices = {};
        
        // 기기 선택 함수
        function selectDevice(deviceId) {
            currentDevice = deviceId;
            updateDeviceSelection();
            
            // 선택된 기기의 센서 데이터로 UI 업데이트
            if (devices[deviceId]) {
                updateSensorValues(devices[deviceId]);
            }
            
            // 토픽 표시 업데이트
            document.getElementById('current-device-id').textContent = deviceId;
            document.getElementById('current-topic-sensor').textContent = `myhome/livingroom/${deviceId}/status`;
            document.getElementById('current-topic-control').textContent = `myhome/livingroom/${deviceId}/command`;
        }
        
        // 기기 선택 UI 업데이트
        function updateDeviceSelection() {
            const select = document.getElementById('device-select');
            
            // 기기 목록 업데이트
            const options = select.getElementsByTagName('option');
            for (let i = options.length - 1; i > 0; i--) {
                select.removeChild(options[i]);
            }
            
            // 기기 목록 추가
            Object.keys(devices).forEach(deviceId => {
                const option = document.createElement('option');
                option.value = deviceId;
                option.textContent = deviceId;
                if (devices[deviceId].lastSeen) {
                    // 마지막 활동 시간 표시
                    const lastSeen = new Date(devices[deviceId].lastSeen * 1000);
                    const timeStr = lastSeen.toLocaleTimeString();
                    option.textContent = `${deviceId} (상태: ${devices[deviceId].online ? '온라인' : '오프라인'}, 마지막 응답: ${timeStr})`;
                }
                select.appendChild(option);
            });
            
            // 현재 선택된 기기 표시
            select.value = currentDevice;
            
            // 기기 목록 영역 표시/숨김
            const deviceCount = Object.keys(devices).length;
            document.getElementById('devices-count').textContent = deviceCount;
            document.getElementById('no-devices-message').style.display = deviceCount > 0 ? 'none' : 'block';
            document.getElementById('device-controls').style.display = currentDevice ? 'block' : 'none';
        }
        
        // 기기 추가 함수
        function addDevice(deviceId, data) {
            // 이미 있는 기기인 경우 정보 업데이트
            if (devices[deviceId]) {
                devices[deviceId] = {...devices[deviceId], ...data, lastSeen: data.timestamp || Math.floor(Date.now() / 1000), online: true};
            } else {
                // 새 기기 추가
                devices[deviceId] = {...data, lastSeen: data.timestamp || Math.floor(Date.now() / 1000), online: true};
                console.log(`새 기기 발견: ${deviceId}`);
                
                // 첫 번째 기기인 경우 자동 선택
                if (Object.keys(devices).length === 1) {
                    currentDevice = deviceId;
                }
            }
            
            // 현재 선택된 기기와 같은 경우, UI 업데이트
            if (deviceId === currentDevice) {
                updateSensorValues(data);
            }
            
            // 기기 목록 UI 업데이트
            updateDeviceSelection();
        }
        
        // 기기 상태 검사 함수 (일정 시간 동안 응답이 없는 기기 확인)
        function checkDevicesStatus() {
            const now = Math.floor(Date.now() / 1000);
            const timeout = 60; // 60초 동안 응답 없으면 오프라인으로 간주
            
            Object.keys(devices).forEach(deviceId => {
                const device = devices[deviceId];
                if (device.lastSeen && now - device.lastSeen > timeout) {
                    if (device.online) {
                        console.log(`기기 ${deviceId} 오프라인 상태로 변경`);
                        devices[deviceId].online = false;
                        updateDeviceSelection();
                    }
                }
            });
        }
        
        // 주기적으로 기기 상태 검사
        setInterval(checkDevicesStatus, 10000); // 10초마다 검사
        
        let client;
        let sensorChart;
        let chartData = {
            labels: [],
            temperature: [],
            humidity: [],
            touch1: [],
            touch2: []
        };
        
        // 차트 초기화
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: '온도 (°C)',
                            data: chartData.temperature,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        },
                        {
                            label: '습도 (%)',
                            data: chartData.humidity,
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        },
                        {
                            label: '터치 1',
                            data: chartData.touch1,
                            borderColor: 'rgb(255, 206, 86)',
                            tension: 0.1
                        },
                        {
                            label: '터치 2',
                            data: chartData.touch2,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // MQTT 연결 설정
        function connectMQTT() {
            try {
                // 클라이언트 생성
                client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
                
                // 콜백 설정
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;
                
                // 연결 옵션 설정
                const options = {
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    useSSL: false,
                    timeout: 30, // 연결 타임아웃 (초)
                    keepAliveInterval: 60, // 키퍼알라이브 인터벌 (초)
                    cleanSession: true
                };
                
                // 연결 시도
                client.connect(options);
                
                console.log('MQTT 연결 시도 중...');
            } catch (error) {
                console.error('MQTT 클라이언트 생성 오류:', error);
                onConnectFailure({ errorCode: 'AMQJS0007E', errorMessage: 'MQTT 클라이언트 생성 실패' });
            }
        }
        
        // 연결 성공
        function onConnect() {
            document.getElementById('connection-status').textContent = '연결 상태: 연결됨';
            document.getElementById('connection-status').style.backgroundColor = '#d4edda';
            
            // 센서 토픽 구독
            client.subscribe(MQTT_TOPIC_SENSOR);
            console.log("MQTT 브로커에 연결 성공");
        }
        
        // 연결 실패
        function onConnectFailure(error) {
            document.getElementById('connection-status').textContent = '연결 상태: 연결 실패 - ' + error.errorMessage;
            document.getElementById('connection-status').style.backgroundColor = '#f8d7da';
            console.log("MQTT 연결 실패:", error);
            
            // 5초 후 재연결
            setTimeout(connectMQTT, 5000);
        }
        
        // 연결 끊김
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                document.getElementById('connection-status').textContent = '연결 상태: 연결 끊김 - ' + responseObject.errorMessage;
                document.getElementById('connection-status').style.backgroundColor = '#fff3cd';
                console.log("MQTT 연결 끊김:", responseObject.errorMessage);
                
                // 3초 후 재연결
                setTimeout(connectMQTT, 3000);
            }
        }
        
        function onMessageArrived(message) {
            console.log("메시지 수신:", message.destinationName, message.payloadString);
            
            try {
                // 토픽에서 기기 ID 추출
                const topicParts = message.destinationName.split('/');
                const deviceId = topicParts[2];
                const messageType = topicParts[3]; // status, command, lcd 등
                
                if (!deviceId) {
                    console.warn('잘못된 토픽 형식:', message.destinationName);
                    return;
                }
                
                const data = JSON.parse(message.payloadString);
                
                // 데이터에 device_id가 없는 경우 추가 (토픽에서 추출한 ID 사용)
                if (!data.device_id) {
                    data.device_id = deviceId;
                }
                
                // 새 기기 발견 또는 기존 기기 업데이트
                addDevice(deviceId, data);
                
                // 메시지 유형에 따른 처리
                if (messageType === 'status') {
                    // 현재 선택된 기기의 상태일 경우만 UI 업데이트
                    if (deviceId === currentDevice) {
                        updateSensorValues(data);
                        updateChart(data);
                    }
                } else if (messageType === 'lcd') {
                    // LCD 메시지일 경우, 현재 선택된 기기의 메시지일 경우만 처리
                    if (deviceId === currentDevice) {
                        const preview1 = document.getElementById('lcd-line1');
                        const preview2 = document.getElementById('lcd-line2');
                        
                        if (data.line1 !== undefined) {
                            const line1 = data.line1;
                            const line2 = data.line2 || '';
                            
                            if (line1.length > 32) {
                                // 32자 이상이면 두 줄로 나누기
                                preview1.textContent = line1.substring(0, 16);
                                preview2.textContent = line1.substring(16, 32);
                            } else if (line1.length > 16) {
                                // 16자 이상이면 두번째 줄로 나누기
                                preview1.textContent = line1.substring(0, 16);
                                preview2.textContent = line1.substring(16, 32);
                            } else {
                                preview1.textContent = line1;
                                preview2.textContent = line2 || '';
                            }
                        } else if (data.line1 !== undefined && data.line2 !== undefined) {
                            // 두 줄 따로 전달된 경우
                            preview1.textContent = data.line1.substring(0, 16);
                            preview2.textContent = data.line2.substring(0, 16);
                        }
                    }
                }
                
                // 장치 상태 정보 발행 (몇 개의 기기가 온라인 상태인지)
                const onlineDevices = Object.values(devices).filter(d => d.online).length;
                document.getElementById('devices-count').textContent = onlineDevices;
                
            } catch (e) {
                console.error('MQTT 메시지 처리 오류:', e, message.payloadString);
            }
        }

        
        // 센서 데이터 업데이트
        function updateSensorValues(data) {
            // 온습도 값 업데이트
            if (data.temperature !== undefined) {
                document.getElementById('temperature').textContent = data.temperature.toFixed(1) + '°C';
            }
            if (data.humidity !== undefined) {
                document.getElementById('humidity').textContent = data.humidity.toFixed(1) + '%';
            }
            // 터치 센서 현재 값 업데이트
            if (data.touch1 !== undefined) {
                document.getElementById('touch1').textContent = data.touch1;
            }
            if (data.touch2 !== undefined) {
                document.getElementById('touch2').textContent = data.touch2;
            }
            if (data.touch3 !== undefined) {
                document.getElementById('touch3').textContent = data.touch3;
            }
            if (data.touch4 !== undefined) {
                document.getElementById('touch4').textContent = data.touch4;
            }
            // 터치 센서 누적 값 업데이트
            if (data.touch_count1 !== undefined) {
                document.getElementById('touch_count1').textContent = data.touch_count1;
            }
            if (data.touch_count2 !== undefined) {
                document.getElementById('touch_count2').textContent = data.touch_count2;
            }
            if (data.touch_count3 !== undefined) {
                document.getElementById('touch_count3').textContent = data.touch_count3;
            }
            if (data.touch_count4 !== undefined) {
                document.getElementById('touch_count4').textContent = data.touch_count4;
            }
        }      
        // 차트 업데이트
        function updateChart(data) {
            // 시간 레이블 생성
            const now = new Date();
            const timeLabel = now.getHours() + ':' + 
                             (now.getMinutes() < 10 ? '0' : '') + now.getMinutes() + ':' + 
                             (now.getSeconds() < 10 ? '0' : '') + now.getSeconds();
            
            // 차트 데이터 업데이트 (최대 20개 포인트 유지)
            chartData.labels.push(timeLabel);
            chartData.temperature.push(data.temperature);
            chartData.humidity.push(data.humidity);
            
            // 터치 센서 데이터 추가 (있는 경우에만)
            if (data.touch1 !== undefined) {
                chartData.touch1.push(data.touch1);
            } else if (chartData.touch1.length > 0) {
                // 데이터가 없는 경우 마지막 값 반복
                chartData.touch1.push(chartData.touch1[chartData.touch1.length - 1]);
            } else {
                // 데이터가 아예 없는 경우 0
                chartData.touch1.push(0);
            }
            
            if (data.touch2 !== undefined) {
                chartData.touch2.push(data.touch2);
            } else if (chartData.touch2.length > 0) {
                chartData.touch2.push(chartData.touch2[chartData.touch2.length - 1]);
            } else {
                chartData.touch2.push(0);
            }
            
            // 최대 데이터 개수 제한
            if (chartData.labels.length > 20) {
                chartData.labels.shift();
                chartData.temperature.shift();
                chartData.humidity.shift();
                chartData.touch1.shift();
                chartData.touch2.shift();
            }
            
            // 차트 업데이트
            sensorChart.update();
        }
        
        // MQTT 메시지 발행
        function publishMessage(topic, message) {
            if (!client || !client.isConnected()) {
                alert("MQTT 브로커에 연결되어 있지 않습니다. 페이지를 새로고침하세요.");
                return;
            }
            
            if (!currentDevice) {
                alert("먼저 제어할 기기를 선택해주세요.");
                return;
            }
            
            // 토픽을 현재 선택된 기기에 맞게 수정
            const actualTopic = topic.replace('+', currentDevice);
            
            // JSON 형식으로 메시지 전송 (문자열화 이중 적용 오류 방지)
            let messageStr;
            // 메시지가 문자열이 아니면 JSON으로 만들고, 이미 문자열이면 그대로 사용
            if (typeof message === 'object') {
                messageStr = JSON.stringify(message);
            } else {
                messageStr = message;
            }
            
            const mqttMessage = new Paho.MQTT.Message(messageStr);
            mqttMessage.destinationName = actualTopic;
            client.send(mqttMessage);
            console.log("제어 메시지 발행:", actualTopic, messageStr);
        }
        
        // RGB 미리보기 업데이트 함수
        function updateRgbPreview() {
            const r = document.getElementById('rgb-red').value;
            const g = document.getElementById('rgb-green').value;
            const b = document.getElementById('rgb-blue').value;
            
            document.getElementById('rgb-red-value').textContent = r;
            document.getElementById('rgb-green-value').textContent = g;
            document.getElementById('rgb-blue-value').textContent = b;
            
            const preview = document.getElementById('rgb-preview');
            preview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        }
        
        // 페이지 로드 시 실행
        window.onload = function() {
            // 차트 초기화
            initChart();
            
            // MQTT 연결
            connectMQTT();
            
            // 서보 모터 컨트롤 이벤트 - 값 변경 시 표시만 업데이트
            document.getElementById('servo-control').addEventListener('input', function() {
                const angle = this.value;
                document.getElementById('servo-value').textContent = angle + '°';
                // 값 변경 시 전송하지 않고 화면만 업데이트
            });
            
            // 서보 위치 설정 버튼 - 버튼 클릭 시에만 전송
            document.getElementById('servo-send').addEventListener('click', function() {
                const angle = document.getElementById('servo-control').value;
                console.log('서보모터 제어:', angle + '°');
                publishMessage(MQTT_TOPIC_CONTROL, {servo: parseInt(angle)});
            });
            
            // RGB LED 제어 이벤트
            document.getElementById('rgb-red').addEventListener('input', function() {
                updateRgbPreview(); // 화면만 업데이트
            });
            
            document.getElementById('rgb-green').addEventListener('input', function() {
                updateRgbPreview(); // 화면만 업데이트
            });
            
            document.getElementById('rgb-blue').addEventListener('input', function() {
                updateRgbPreview(); // 화면만 업데이트
            });
            
            // 초기 RGB 미리보기 업데이트
            updateRgbPreview();
            
            // RGB LED 설정 버튼 - 버튼 클릭 시에만 전송
            document.getElementById('rgb-send').addEventListener('click', function() {
                const r = parseInt(document.getElementById('rgb-red').value);
                const g = parseInt(document.getElementById('rgb-green').value);
                const b = parseInt(document.getElementById('rgb-blue').value);
                console.log(`RGB LED 설정: R=${r}, G=${g}, B=${b}`);
                publishMessage(MQTT_TOPIC_CONTROL, {rgb: [r, g, b]});
                
                // 사용자에게 피드백 제공
                const button = document.getElementById('rgb-send');
                button.innerHTML = '전송됨!';
                button.classList.add('btn-success');
                
                // 1초 후 버튼 상태 복구
                setTimeout(function() {
                    button.innerHTML = 'LED 색상 설정';
                    button.classList.remove('btn-success');
                }, 1000);
            });
            
            // RGB 프리셋 색상 버튼
            document.querySelectorAll('.color-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const colorValues = JSON.parse(this.dataset.color);
                    document.getElementById('rgb-red').value = colorValues[0];
                    document.getElementById('rgb-green').value = colorValues[1];
                    document.getElementById('rgb-blue').value = colorValues[2];
                    updateRgbPreview();
                    publishMessage(MQTT_TOPIC_CONTROL, {rgb: colorValues});
                });
            });
            
            // 부저 제어 이벤트
            document.getElementById('buzzer-send').addEventListener('click', function() {
                const freq = parseInt(document.getElementById('buzzer-freq').value);
                const duration = parseInt(document.getElementById('buzzer-duration').value);
                publishMessage(MQTT_TOPIC_CONTROL, {
                    buzzer: {
                        freq: freq,
                        duration: duration
                    }
                });
            });
            
            document.getElementById('buzzer-stop').addEventListener('click', function() {
                publishMessage(MQTT_TOPIC_CONTROL, {buzzer: 0});
            });
            
            // 부저 음악 노트 프리셋
            document.querySelectorAll('.note-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const freq = parseInt(this.dataset.freq);
                    const duration = parseInt(document.getElementById('buzzer-duration').value);
                    publishMessage(MQTT_TOPIC_CONTROL, {
                        buzzer: {
                            freq: freq,
                            duration: duration
                        }
                    });
                });
            });
            
            // LCD 제어 이벤트 - 단일 줄 입력 버전
            document.getElementById('lcd-send').addEventListener('click', function() {
                const text = document.getElementById('lcd-text').value;
                if (text) {
                    // LCD 미리보기 업데이트
                    updateLcdPreview(text);
                    
                    // 버튼 피드백 제공
                    const button = this;
                    button.innerHTML = '전송됨!';
                    button.classList.add('btn-success');
                    setTimeout(function() {
                        button.innerHTML = 'LCD 표시';
                        button.classList.remove('btn-success');
                    }, 1000);
                    
                    console.log('LCD 메시지 전송:', text);
                    publishMessage(MQTT_TOPIC_CONTROL, {lcd: text});
                }
            });
            
            // LCD 이줄 입력 버전
            document.getElementById('lcd-two-lines-send').addEventListener('click', function() {
                const line1 = document.getElementById('lcd-line1').value;
                const line2 = document.getElementById('lcd-line2').value;
                
                if (line1 || line2) {  // 하나라도 값이 있으면 전송
                    // LCD 미리보기 업데이트
                    updateLcdPreview(line1, line2);
                    
                    // 버튼 피드백 제공
                    const button = this;
                    button.innerHTML = '전송됨!';
                    button.classList.add('btn-success');
                    setTimeout(function() {
                        button.innerHTML = '두 줄 표시';
                        button.classList.remove('btn-success');
                    }, 1000);
                    
                    console.log('LCD 두 줄 메시지 전송:', line1, line2);
                    // 두 줄 LCD 형식으로 전송
                    publishMessage(MQTT_TOPIC_CONTROL, {
                        lcd: {
                            line1: line1,
                            line2: line2
                        }
                    });
                }
            });
            
            // LCD 미리보기 업데이트 함수
            function updateLcdPreview(line1, line2 = null) {
                const preview1 = document.getElementById('lcd-preview-line1');
                const preview2 = document.getElementById('lcd-preview-line2');
                
                if (line2 === null) {
                    // 한 줄만 전달된 경우, 자동 줄바꿈 처리
                    if (line1.includes('\n')) {
                        const lines = line1.split('\n', 2);
                        preview1.textContent = lines[0].substring(0, 16);
                        preview2.textContent = lines.length > 1 ? lines[1].substring(0, 16) : '';
                    } else if (line1.length > 16) {
                        // 16자 이상이면 두번째 줄로 나누기
                        preview1.textContent = line1.substring(0, 16);
                        preview2.textContent = line1.substring(16, 32);
                    } else {
                        preview1.textContent = line1;
                        preview2.textContent = '';
                    }
                } else {
                    // 두 줄 따로 전달된 경우
                    preview1.textContent = line1.substring(0, 16);
                    preview2.textContent = line2.substring(0, 16);
                }
            }
        };
    </script>
</body>
</html>